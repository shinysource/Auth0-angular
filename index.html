<!DOCTYPE html>

<html>
<head>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.5/angular.min.js" type="text/javascript"> </script>
  <script src="//d19p4zemcycm7a.cloudfront.net/w2/auth0-widget-2.3.js" type="text/javascript"> </script>
  <script src="//code.angularjs.org/1.2.5/angular-route.min.js" type="text/javascript"> </script>
  <script src="//code.angularjs.org/1.2.5/angular-cookies.min.js" type="text/javascript"> </script>

  <title></title>
</head>


<body>
  <div ng-app="myApp">
    <script type="text/ng-template" id="main.html">
      <div>{{message}}</div>
    </script>

    <script type="text/ng-template" id="login.html">
      <div id="login-container">
      </div>
    </script>
    
    <script type="text/ng-template" id="logout.html">
      <div>Logging out...</div>
    </script>

    <div ng-controller="MenuCtrl">
      <a href="" ng-click="go('/main')">main</a>
      <a href="" ng-click="go('/login')">login</a>
      <a href="" ng-click="go('/logout')">logout</a>
    </div>

    <div ng-view>
    </div>
  </div>
  
</body>
<script type="text/javascript">

var myApp = angular.module('myApp', [
  'ngCookies', 'ngRoute'
]);

myApp.config(function ($routeProvider) {
  
  $routeProvider
  .when('/main',    { templateUrl: 'main.html',     controller: 'MainCtrl'    })
  .when('/logout',  { templateUrl: 'logout.html',   controller: 'LogoutCtrl'  })
  .when('/login',   { templateUrl: 'login.html',    controller: 'LoginCtrl'   })

  .otherwise({ redirectTo: '/login' });
  
});

myApp.controller('MenuCtrl', function ($scope, $location) {
  $scope.go = function (target) {
    $location.path(target);
  };
});

myApp.controller('LoginCtrl', function ($scope, $rootScope) {
  var oldWidget = document.querySelector('#a0-widget')
  if (oldWidget) {
    oldWidget.remove();
  }
  $rootScope.Auth0Widget.signin();
});

myApp.controller('LogoutCtrl', function ($scope, $cookies, $location) {
  $cookies.profile = undefined;
  $location.path('/login');
});

myApp.controller('MainCtrl', function ($scope, $cookies, $location) {
  if ($cookies.profile) {
    $scope.message = "Welcome " + JSON.parse($cookies.profile).name;
  } else {
    $location.path('/login');
  }
})
.run(function ($rootScope, $cookies, $location) {
  $rootScope.Auth0Widget = new Auth0Widget({
      domain: 'YOUR_DOMAIN', 
      clientID: 'YOUR_CLIENT_ID', 
      callbackURL: 'YOUR_CALLBACK_URL',
      callbackOnLocationHash: true
  });

    $rootScope.Auth0Widget.parseHash(window.location.hash, function (profile, id_token, access_token, state) { 
    $cookies.profile = JSON.stringify(profile);
    $location.path('/main');
  });

});

  </script>
</html>
